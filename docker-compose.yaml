version: "3.4"
services:
  init-geth:
    image: ethereum/client-go:latest
    container_name: geth-init
    volumes:
      - $EXECUTION_DATA_VOLUME:/execution_data
      - $CONFIGS_VOLUME:/configs
    command: >
      --datadir=/execution_data init ./configs/genesis.json
  geth:
    image: ethereum/client-go:latest
    container_name: geth
    depends_on:
      - init-geth
    volumes:
      - $EXECUTION_DATA_VOLUME:/execution_data
      - $CONFIGS_VOLUME:/configs
    restart: unless-stopped
    stop_signal: SIGINT
    stop_grace_period: 2m
    command: >
      --datadir=/execution_data 
      --ws 
      --ws.api "net,eth,debug,engine"  
      --nat extip:$EXTERNAL_IP
      --http 
      --http.api "net,eth,debug,engine" 
      --http.addr "0.0.0.0" 
      --verbosity $GETH_VERBOSITY
      --port $GETH_PEER_PORT
      --http.port $GETH_HTTP_PORT 
      --mine
      --miner.threads 1
      --miner.gaslimit 60000000
      --miner.etherbase 0x8eFdC93aE5FEa9287e7a22B6c14670BfcCdA997b
      --authrpc.jwtsecret /configs/jwt.hex
    network_mode: host

  prysm_beacon:
    image: gcr.io/prysmaticlabs/prysm/beacon-chain:capella-post-merge
    container_name: prysm_beacon
    depends_on:
      - geth
      - eth2stats-client
    volumes:
      - $CONSENSUS_DATA_VOLUME:/consensus_data
      - $CONFIGS_VOLUME:/configs
    restart: unless-stopped
    stop_signal: SIGINT
    stop_grace_period: 2m
    command: >
      --accept-terms-of-use 
      --datadir /consensus_data
      --execution-endpoint=http://localhost:8551
      --jwt-secret=/configs/jwt.hex
      --suggested-fee-recipient=0x8eFdC93aE5FEa9287e7a22B6c14670BfcCdA997b
      --min-sync-peers=0
      --contract-deployment-block 0
      --p2p-host-ip $EXTERNAL_IP
      --chain-config-file /configs/config.yml
      --monitoring-host 0.0.0.0
      --grpc-gateway-host 0.0.0.0
      --suggested-fee-recipient $GETH_ETHERBASE
      --rpc-host 0.0.0.0
      --verbosity $PRYSM_VERBOSITY
      --p2p-max-peers 250
      --subscribe-all-subnets
      --minimum-peers-per-subnet 0
    network_mode: host

  prysm_validator:
    image: gcr.io/prysmaticlabs/prysm/validator:capella-post-merge
    container_name: prysm_validator
    volumes:
      - $KEYSTORE_VOLUME:/keystore
      - $VALIDATOR_DATA_VOLUME:/validator_data
      - $CONFIGS_VOLUME:/configs
    restart: unless-stopped
    depends_on:
      - prysm_beacon
    stop_signal: SIGINT
    stop_grace_period: 2m
    command: >
      --accept-terms-of-use
      --datadir /validator_data
      --wallet-dir /keystore
      --wallet-password-file /keystore/password.txt
      --chain-config-file /configs/config.yml
      --monitoring-host 0.0.0.0
      --grpc-gateway-host 0.0.0.0
      --rpc-host 0.0.0.0
      --suggested-fee-recipient $GETH_ETHERBASE
    network_mode: host